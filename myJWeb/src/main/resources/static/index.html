<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MyJWeb - HTTP 调试 MVP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
            color: #1f2937;
            background: #f8fafc;
        }
        body {
            margin: 0;
            padding: 24px;
        }
        h1 {
            margin: 0 0 16px 0;
            font-size: 22px;
            color: #0f172a;
        }
        .card {
            background: #fff;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(15,23,42,0.08);
            margin-bottom: 16px;
        }
        .grid {
            display: grid;
            gap: 12px;
        }
        .two-col {
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }
        input, select, textarea, button {
            width: 100%;
            box-sizing: border-box;
            font: inherit;
        }
        input, select, textarea {
            padding: 10px;
            border: 1px solid #d0d7e2;
            border-radius: 6px;
            background: #f8fafc;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        .row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .row > *:first-child { flex: 0 0 120px; }
        .row > *:last-child { flex: 1; }
        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .primary { background: #2563eb; color: #fff; }
        .ghost { background: #e2e8f0; color: #0f172a; }
        .ghost.small {
            padding: 6px 10px;
            font-weight: 500;
        }
        pre {
            background: #0f172a;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
            white-space: pre-wrap;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            background: #e2e8f0;
        }
        .success { background: #dcfce7; color: #166534; }
        .fail { background: #fee2e2; color: #991b1b; }
        .muted { color: #6b7280; font-size: 13px; }
        .error { color: #b91c1c; font-weight: 700; }
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }
        .section-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .kv-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .kv-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)) 36px;
            gap: 8px;
            align-items: center;
        }
        .kv-row button {
            width: 100%;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e2e8f0;
            font-size: 12px;
            font-weight: 600;
        }
        .pill small {
            color: #475569;
            font-weight: 500;
        }
        details summary {
            cursor: pointer;
            font-weight: 700;
        }
        details summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body>
<h1>接口调试台（MVP）</h1>
<div class="card grid two-col">
    <div>
        <label>请求名称</label>
        <input id="name" placeholder="例如：获取用户列表" value="Quick Request">
    </div>
    <div>
        <label>目标 URL</label>
        <input id="url" placeholder="https://api.example.com/users">
    </div>
    <div>
        <label>HTTP 方法</label>
        <select id="method">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>PATCH</option>
            <option>DELETE</option>
        </select>
    </div>
    <div>
        <label>环境 ID（可选，用于变量替换）</label>
        <input id="environmentId" type="number" placeholder="例如：1">
    </div>
    <div>
        <label>超时（毫秒，可选）</label>
        <input id="timeoutMs" type="number" min="0" placeholder="默认 10s">
    </div>
    <div>
        <label>跟随重定向</label>
        <select id="followRedirects">
            <option value="1" selected>是</option>
            <option value="0">否</option>
        </select>
    </div>
    <div>
        <label>鉴权（Basic，可选）</label>
        <input id="authUser" placeholder="用户名">
        <input id="authPass" type="password" placeholder="密码" style="margin-top:6px;">
        <div class="muted">留空则不附带 Authorization 头。</div>
    </div>
    <div>
        <label>请求体类型</label>
        <select id="bodyMode">
            <option value="none">无</option>
            <option value="json">JSON</option>
            <option value="raw">Raw 文本</option>
        </select>
        <input id="bodyMime" placeholder="Content-Type（可选）" style="margin-top:6px;" value="application/json">
    </div>
</div>

<div class="card grid two-col">
    <div>
        <div class="section-header">
            <label>Headers</label>
            <div class="section-actions">
                <button id="headersToggleBtn" class="ghost small">切换为 JSON</button>
                <button id="headersAddBtn" class="ghost small">新增一行</button>
            </div>
        </div>
        <div class="muted" style="margin-bottom:8px;">可视化列表编辑，或切换为 JSON 粘贴/批量编辑。</div>
        <div id="headersList" class="kv-list"></div>
        <textarea id="headersInput" placeholder='{"Content-Type":"application/json"}' style="display:none;"></textarea>
    </div>
    <div>
        <div class="section-header">
            <label>Query Params</label>
            <div class="section-actions">
                <button id="queryToggleBtn" class="ghost small">切换为 JSON</button>
                <button id="queryAddBtn" class="ghost small">新增一行</button>
            </div>
        </div>
        <div class="muted" style="margin-bottom:8px;">快速添加查询字符串，或切换为 JSON。</div>
        <div id="queryList" class="kv-list"></div>
        <textarea id="queryInput" placeholder='{"page":"1"}' style="display:none;"></textarea>
    </div>
    <div>
        <div class="section-header">
            <label>Cookies</label>
            <div class="section-actions">
                <button id="cookiesToggleBtn" class="ghost small">切换为 JSON</button>
                <button id="cookiesAddBtn" class="ghost small">新增一行</button>
            </div>
        </div>
        <div class="muted" style="margin-bottom:8px;">输入键值对或切换 JSON。</div>
        <div id="cookiesList" class="kv-list"></div>
        <textarea id="cookiesInput" placeholder='{"session":"token"}' style="display:none;"></textarea>
    </div>
    <div>
        <div class="section-header">
            <label>Body / GraphQL / Form</label>
            <div class="section-actions">
                <button id="bodyToggleBtn" class="ghost small">切换为 JSON</button>
                <button id="bodyAddBtn" class="ghost small">新增一行</button>
            </div>
        </div>
        <div class="muted" style="margin-bottom:8px;">JSON 模式支持列表与 JSON 文本双向切换；Raw 模式直接填写文本。</div>
        <div id="bodyList" class="kv-list"></div>
        <textarea id="bodyJsonInput" placeholder='{"key":"value"}' style="display:none;"></textarea>
        <textarea id="bodyRawInput" placeholder="Raw 文本" style="display:none;"></textarea>
    </div>
</div>

<div class="card actions">
    <button class="ghost" id="resetBtn">清空</button>
    <button class="primary" id="sendBtn">发送并执行</button>
</div>

<div class="card">
    <div class="row" style="margin-bottom:8px;">
        <div class="badge" id="statusBadge">未执行</div>
        <div class="muted" id="durationLabel"></div>
    </div>
    <div class="muted" id="hint">响应详情将展示在这里。</div>
    <pre id="responseHeaders" style="display:none;"></pre>
    <pre id="responseBody" style="display:none;"></pre>
    <div class="error" id="errorBox" style="display:none;"></div>
</div>

<script>
    const sendBtn = document.getElementById("sendBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusBadge = document.getElementById("statusBadge");
    const durationLabel = document.getElementById("durationLabel");
    const hint = document.getElementById("hint");
    const responseHeaders = document.getElementById("responseHeaders");
    const responseBody = document.getElementById("responseBody");
    const errorBox = document.getElementById("errorBox");
    const bodyModeSelect = document.getElementById("bodyMode");

    const kvState = {
        headers: { list: [{ key: "", value: "" }], mode: "list" },
        query: { list: [{ key: "", value: "" }], mode: "list" },
        cookies: { list: [{ key: "", value: "" }], mode: "list" },
        body: { list: [{ key: "", value: "" }], mode: "list" }
    };

    function setStatus(text, success) {
        statusBadge.textContent = text;
        statusBadge.className = "badge " + (success === true ? "success" : success === false ? "fail" : "");
    }

    function setError(message) {
        if (message) {
            errorBox.style.display = "block";
            errorBox.textContent = message;
        } else {
            errorBox.style.display = "none";
            errorBox.textContent = "";
        }
    }

    function toBase64(text) {
        return btoa(unescape(encodeURIComponent(text)));
    }

    function decodeBase64(text, charset = "utf-8") {
        if (!text) return "";
        try {
            return decodeURIComponent(escape(atob(text)));
        } catch (e) {
            return text;
        }
    }

    function buildAuthHeader() {
        const user = document.getElementById("authUser").value;
        const pass = document.getElementById("authPass").value;
        if (!user) return null;
        const token = btoa(`${user}:${pass}`);
        return `Basic ${token}`;
    }

    function resetOutputs() {
        setStatus("未执行");
        durationLabel.textContent = "";
        hint.style.display = "block";
        responseHeaders.style.display = "none";
        responseBody.style.display = "none";
        responseHeaders.textContent = "";
        responseBody.textContent = "";
        setError("");
    }

    function ensureListHasRow(list) {
        if (list.length === 0) {
            list.push({ key: "", value: "" });
        }
    }

    function renderKvList(name) {
        const state = kvState[name];
        const listEl = document.getElementById(`${name}List`);
        listEl.innerHTML = "";
        ensureListHasRow(state.list);
        state.list.forEach((item, index) => {
            const row = document.createElement("div");
            row.className = "kv-row";

            const keyInput = document.createElement("input");
            keyInput.placeholder = "键";
            keyInput.value = item.key || "";
            keyInput.addEventListener("input", (e) => {
                state.list[index].key = e.target.value;
            });

            const valueInput = document.createElement("input");
            valueInput.placeholder = "值";
            valueInput.value = item.value || "";
            valueInput.addEventListener("input", (e) => {
                state.list[index].value = e.target.value;
            });

            const removeBtn = document.createElement("button");
            removeBtn.className = "ghost small";
            removeBtn.textContent = "删";
            removeBtn.title = "删除该行";
            removeBtn.addEventListener("click", () => {
                state.list.splice(index, 1);
                renderKvList(name);
            });

            row.appendChild(keyInput);
            row.appendChild(valueInput);
            row.appendChild(removeBtn);
            listEl.appendChild(row);
        });
    }

    function listToJsonString(list) {
        const obj = {};
        list.filter(item => item.key).forEach(item => {
            obj[item.key] = item.value ?? "";
        });
        return JSON.stringify(obj, null, 2);
    }

    function parseJsonToList(text, fieldName) {
        const trimmed = (text || "").trim();
        if (!trimmed) return [];
        try {
            const parsed = JSON.parse(trimmed);
            if (Array.isArray(parsed)) {
                return parsed.map((item) => {
                    if (typeof item === "object" && item !== null && "key" in item && "value" in item) {
                        return { key: String(item.key), value: String(item.value ?? "") };
                    }
                    throw new Error(`${fieldName} 数组元素需包含 key 与 value`);
                });
            }
            if (typeof parsed === "object" && parsed !== null) {
                return Object.entries(parsed).map(([k, v]) => ({ key: String(k), value: String(v ?? "") }));
            }
            throw new Error(`${fieldName} 需为对象或包含 {key,value} 的数组`);
        } catch (e) {
            throw new Error(`${fieldName} 不是有效的 JSON：${e.message}`);
        }
    }

    function toggleKvMode(name, textareaId, toggleBtnId) {
        const state = kvState[name];
        const textarea = document.getElementById(textareaId);
        const toggleBtn = document.getElementById(toggleBtnId);
        const listEl = document.getElementById(`${name}List`);
        if (state.mode === "list") {
            textarea.value = listToJsonString(state.list);
            textarea.style.display = "block";
            listEl.style.display = "none";
            state.mode = "json";
            toggleBtn.textContent = "切换为列表";
        } else {
            try {
                state.list = parseJsonToList(textarea.value, name);
                renderKvList(name);
                textarea.style.display = "none";
                listEl.style.display = "flex";
                state.mode = "list";
                toggleBtn.textContent = "切换为 JSON";
                setError("");
            } catch (e) {
                setError(e.message);
            }
        }
    }

    function bindKvSection(name, textareaId, toggleBtnId, addBtnId) {
        renderKvList(name);
        document.getElementById(toggleBtnId).addEventListener("click", () => {
            toggleKvMode(name, textareaId, toggleBtnId);
        });
        document.getElementById(addBtnId).addEventListener("click", () => {
            kvState[name].list.push({ key: "", value: "" });
            renderKvList(name);
        });
    }

    function getKvJsonString(name, textareaId, label) {
        const state = kvState[name];
        if (state.mode === "list") {
            return listToJsonString(state.list);
        }
        const text = document.getElementById(textareaId).value;
        const trimmed = (text || "").trim();
        if (!trimmed) return "{}";
        try {
            return JSON.stringify(JSON.parse(trimmed));
        } catch (e) {
            throw new Error(`${label} 不是有效的 JSON：${e.message}`);
        }
    }

    function renderBodyEditor() {
        const mode = bodyModeSelect.value;
        const rawArea = document.getElementById("bodyRawInput");
        const jsonArea = document.getElementById("bodyJsonInput");
        const listEl = document.getElementById("bodyList");
        const toggleBtn = document.getElementById("bodyToggleBtn");
        const addBtn = document.getElementById("bodyAddBtn");

        if (mode === "none") {
            rawArea.style.display = "none";
            jsonArea.style.display = "none";
            listEl.style.display = "none";
            toggleBtn.disabled = true;
            addBtn.disabled = true;
            return;
        }
        if (mode === "raw") {
            rawArea.style.display = "block";
            jsonArea.style.display = "none";
            listEl.style.display = "none";
            toggleBtn.disabled = true;
            addBtn.disabled = true;
            return;
        }
        // JSON 模式
        toggleBtn.disabled = false;
        addBtn.disabled = false;
        if (kvState.body.mode === "list") {
            listEl.style.display = "flex";
            jsonArea.style.display = "none";
        } else {
            listEl.style.display = "none";
            jsonArea.style.display = "block";
        }
    }

    resetBtn.addEventListener("click", () => {
        kvState.headers.list = [{ key: "", value: "" }];
        kvState.query.list = [{ key: "", value: "" }];
        kvState.cookies.list = [{ key: "", value: "" }];
        kvState.body.list = [{ key: "", value: "" }];
        kvState.headers.mode = "list";
        kvState.query.mode = "list";
        kvState.cookies.mode = "list";
        kvState.body.mode = "list";
        document.getElementById("headersInput").value = "";
        document.getElementById("queryInput").value = "";
        document.getElementById("cookiesInput").value = "";
        document.getElementById("bodyJsonInput").value = "";
        document.getElementById("bodyRawInput").value = "";
        document.getElementById("bodyToggleBtn").textContent = "切换为 JSON";
        document.getElementById("headersToggleBtn").textContent = "切换为 JSON";
        document.getElementById("queryToggleBtn").textContent = "切换为 JSON";
        document.getElementById("cookiesToggleBtn").textContent = "切换为 JSON";
        renderKvList("headers");
        renderKvList("query");
        renderKvList("cookies");
        renderKvList("body");
        renderBodyEditor();
        resetOutputs();
    });

    sendBtn.addEventListener("click", async () => {
        resetOutputs();
        setStatus("执行中…");
        try {
            const payload = buildRequestPayload();
            const headers = {
                "Content-Type": "application/json"
            };
            const authHeader = buildAuthHeader();
            if (authHeader) headers["Authorization"] = authHeader;

            const createRes = await fetch("/api/requests", {
                method: "POST",
                headers,
                body: JSON.stringify(payload)
            });
            if (!createRes.ok) {
                throw new Error(`创建请求失败：${createRes.status} ${await createRes.text()}`);
            }
            const created = await createRes.json();
            const versionId = created.id;

            const environmentIdText = document.getElementById("environmentId").value.trim();
            const execBody = environmentIdText ? { environmentId: Number(environmentIdText) } : null;
            const execHeaders = { ...headers };
            const execRes = await fetch(`/api/request-versions/${versionId}/execute`, {
                method: "POST",
                headers: execBody ? execHeaders : authHeader ? { "Authorization": authHeader } : {},
                body: execBody ? JSON.stringify(execBody) : null
            });
            if (!execRes.ok) {
                throw new Error(`执行失败：${execRes.status} ${await execRes.text()}`);
            }
            const result = await execRes.json();
            renderResult(result);
        } catch (e) {
            setStatus("失败", false);
            setError(e.message);
        }
    });

    function buildRequestPayload() {
        const method = document.getElementById("method").value;
        const url = document.getElementById("url").value.trim();
        const name = document.getElementById("name").value.trim() || url || "Quick Request";
        if (!url) throw new Error("URL 不能为空");

        const payload = {
            name,
            method,
            url,
            headersJson: getKvJsonString("headers", "headersInput", "Headers"),
            queryParamsJson: getKvJsonString("query", "queryInput", "Query Params"),
            cookiesJson: getKvJsonString("cookies", "cookiesInput", "Cookies"),
            timeoutMs: Number(document.getElementById("timeoutMs").value) || null,
            followRedirects: Number(document.getElementById("followRedirects").value) || 0
        };

        const bodyMode = document.getElementById("bodyMode").value;
        const bodyMimeInput = document.getElementById("bodyMime").value.trim();

        if (bodyMode === "json") {
            const jsonStr = getKvJsonString("body", "bodyJsonInput", "Body JSON");
            if (jsonStr && jsonStr !== "{}") {
                payload.bodyJson = jsonStr;
            }
            payload.bodyMime = bodyMimeInput || "application/json";
        } else if (bodyMode === "raw") {
            const rawText = document.getElementById("bodyRawInput").value || "";
            if (rawText.trim()) {
                payload.bodyRaw = toBase64(rawText);
            }
            payload.bodyMime = bodyMimeInput || "text/plain";
        } else {
            payload.bodyMime = bodyMimeInput || "";
        }
        return payload;
    }

    function renderResult(result) {
        const success = result.success === 1 || (result.statusCode >= 200 && result.statusCode < 400);
        setStatus(`状态: ${result.statusCode ?? "N/A"}`, success);
        durationLabel.textContent = `耗时: ${result.durationMs ?? "-"} ms | 大小: ${result.responseSize ?? "-"} bytes`;
        hint.style.display = "none";

        responseHeaders.style.display = "block";
        responseHeaders.textContent = `响应头:\n${JSON.stringify(JSON.parse(result.responseHeadersJson || "{}"), null, 2)}`;

        responseBody.style.display = "block";
        const decoded = decodeBase64(result.responseBody);
        responseBody.textContent = `响应体 (${result.responseMime || "unknown"}; ${result.responseCharset || ""}):\n\n${decoded}`;
    }

    // 初始化 KV 区块与事件
    bindKvSection("headers", "headersInput", "headersToggleBtn", "headersAddBtn");
    bindKvSection("query", "queryInput", "queryToggleBtn", "queryAddBtn");
    bindKvSection("cookies", "cookiesInput", "cookiesToggleBtn", "cookiesAddBtn");
    bindKvSection("body", "bodyJsonInput", "bodyToggleBtn", "bodyAddBtn");
    bodyModeSelect.addEventListener("change", renderBodyEditor);
    renderBodyEditor();
</script>
</body>
</html>
